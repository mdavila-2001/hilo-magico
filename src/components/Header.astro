---
// src/components/Header.astro

import type { User } from '../utils/auth';
import { isAdmin, getCurrentUser } from '../utils/auth';

// Obtener usuario actual
const usuario = getCurrentUser();
const autenticado = usuario !== null;
const esAdmin = autenticado && isAdmin();

// Mostrar informaci√≥n de autenticaci√≥n en consola
console.group('üîê Estado de autenticaci√≥n');
console.log('¬øUsuario autenticado?:', autenticado ? '‚úÖ S√≠' : '‚ùå No');
if (autenticado && usuario) {
  console.log('üë§ Usuario:', getNombreCompleto(usuario));
  console.log('üìß Email:', usuario.email);
  console.log('üëë ¬øEs administrador?:', esAdmin ? 'S√≠' : 'No');
  console.log('üîë Token:', localStorage.getItem('access_token') ? 'Presente' : 'No encontrado');
} else {
  console.log('üîí No hay sesi√≥n activa');
}
console.groupEnd();

// Funci√≥n para obtener el nombre completo del usuario
const getNombreCompleto = (user: User | null): string => {
  if (!user) return 'Usuario';
  const { first_name, middle_name, last_name, mother_last_name } = user;
  return [first_name, middle_name, last_name, mother_last_name]
    .filter(Boolean)
    .join(' ');
};

// Navegaci√≥n principal
const enlaces = [
  { texto: 'Inicio', url: '/' },
  { texto: 'Cat√°logo', url: '/catalog' },
  { texto: 'Servicios', url: '/services' },
  { texto: 'Galer√≠a', url: '/gallery' },
  { texto: 'Contacto', url: '/contact' },
];

// Enlaces de administrador
const adminEnlaces = [
  { texto: 'Panel', url: '/admin' },
  { texto: 'Productos', url: '/admin/products' },
  { texto: '√ìrdenes', url: '/admin/orders' },
  { texto: 'Usuarios', url: '/admin/users' },
];

// Funciones para el men√∫ m√≥vil
const toggleMenu = () => {
  const nav = document.querySelector('.header__nav');
  const overlay = document.querySelector('.header__overlay');
  const body = document.body;
  
  if (nav && overlay) {
    const isOpen = nav.classList.contains('header__nav--abierto');
    
    if (isOpen) {
      nav.classList.remove('header__nav--abierto');
      overlay.classList.remove('header__overlay--visible');
      body.classList.remove('body-menu-abierto');
    } else {
      nav.classList.add('header__nav--abierto');
      overlay.classList.add('header__overlay--visible');
      body.classList.add('body-menu-abierto');
    }
  }
};

const closeMenu = () => {
  const nav = document.querySelector('.header__nav');
  const overlay = document.querySelector('.header__overlay');
  const body = document.body;
  
  if (nav && overlay) {
    nav.classList.remove('header__nav--abierto');
    overlay.classList.remove('header__overlay--visible');
    body.classList.remove('body-menu-abierto');
  }
};

// Funci√≥n para alternar el men√∫ de usuario
const toggleUserMenu = () => {
  const userMenu = document.querySelector('.header__usuario-menu');
  if (userMenu) {
    userMenu.classList.toggle('header__usuario-menu--visible');
  }
};

// Cerrar men√∫ de usuario al hacer clic fuera
const handleClickOutside = (event: MouseEvent) => {
  const userMenu = document.querySelector('.header__usuario-menu');
  const userButton = document.querySelector('.header__usuario-avatar');
  
  if (userMenu && userButton && 
      !userMenu.contains(event.target as Node) && 
      !userButton.contains(event.target as Node)) {
    userMenu.classList.remove('header__usuario-menu--visible');
  }
};

// Funci√≥n para manejar el cierre de sesi√≥n
const handleLogout = async () => {
  try {
    const response = await fetch('/api/auth/logout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    });
    
    if (response.ok) {
      // Limpiar el estado local
      localStorage.removeItem('user');
      localStorage.removeItem('access_token');
      // Redirigir a la p√°gina de inicio
      window.location.href = '/';
    } else {
      console.error('Error al cerrar sesi√≥n');
    }
  } catch (error) {
    console.error('Error al cerrar sesi√≥n:', error);
  }
};
---

<script>
  // Funci√≥n para alternar el carrito
  function toggleCarrito(abrir?: boolean) {
    const carrito = document.getElementById('carrito');
    const carritoBtn = document.getElementById('carrito-btn');
    
    if (carrito && carritoBtn) {
      const estaAbierto = abrir ?? !carrito.classList.contains('carrito--activo');
      
      if (estaAbierto) {
        carrito.classList.add('carrito--activo');
        carritoBtn.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
      } else {
        carrito.classList.remove('carrito--activo');
        carritoBtn.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }
    }
  }

  // Script que se ejecutar√° en el cliente
  document.addEventListener('DOMContentLoaded', () => {
    // Manejo del men√∫ m√≥vil
    const menuBtn = document.querySelector('.header__menu-btn');
    const menu = document.querySelector('.header__nav');
    
    if (menuBtn && menu) {
      // Cerrar men√∫ al hacer clic en un enlace
      document.querySelectorAll('.header__enlace').forEach(enlace => {
        enlace.addEventListener('click', () => {
          menuBtn.setAttribute('aria-expanded', 'false');
          menu.classList.remove('header__nav--activo');
          const overlay = document.getElementById('menu-overlay');
          if (overlay) overlay.classList.remove('header__overlay--active');
        });
      });
    }
    
    // Manejador para los botones de agregar al carrito
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      const botonCarrito = target.closest('.producto__carrito') as HTMLElement;
      
      if (botonCarrito) {
        e.preventDefault();
        
        const id = botonCarrito.getAttribute('data-id');
        const nombre = botonCarrito.getAttribute('data-nombre');
        const precio = botonCarrito.getAttribute('data-precio');
        const imagen = botonCarrito.getAttribute('data-imagen');
        
        if (id && nombre && precio && imagen) {
          // Importar din√°micamente la funci√≥n addToCart
          import('../scripts/cart').then(({ addToCart }) => {
            addToCart({
              id,
              nombre,
              precio: parseFloat(precio),
              imagen
            });
            
            // Mostrar notificaci√≥n
            const notificacion = document.createElement('div');
            notificacion.className = 'notificacion';
            notificacion.textContent = `"${nombre}" se ha a√±adido al carrito`;
            document.body.appendChild(notificacion);
            
            // Eliminar la notificaci√≥n despu√©s de 3 segundos
            setTimeout(() => {
              notificacion.classList.add('mostrar');
              
              setTimeout(() => {
                notificacion.classList.remove('mostrar');
                setTimeout(() => {
                  document.body.removeChild(notificacion);
                }, 300);
              }, 3000);
            }, 0);
          }).catch(error => {
            console.error('Error al cargar el m√≥dulo del carrito:', error);
          });
        }
      }
    });

    // Manejar el bot√≥n del carrito
    const carritoBtn = document.getElementById('carrito-btn');
    if (carritoBtn) {
      carritoBtn.addEventListener('click', (e) => {
        e.preventDefault();
        toggleCarrito(true);
      });
    }

    // Manejar el bot√≥n de cierre del carrito
    const cerrarCarritoBtn = document.querySelector('.carrito__cerrar');
    if (cerrarCarritoBtn) {
      cerrarCarritoBtn.addEventListener('click', (e) => {
        e.preventDefault();
        toggleCarrito(false);
      });
    }
    
    // Manejar clic fuera del carrito para cerrarlo
    document.addEventListener('click', (e: MouseEvent) => {
      const carrito = document.getElementById('carrito');
      const carritoBtn = document.getElementById('carrito-btn');
      const target = e.target as Node | null;
      
      if (carrito && carritoBtn && target && 
          !carrito.contains(target) && 
          !carritoBtn.contains(target) &&
          carrito.classList.contains('carrito--activo')) {
        toggleCarrito(false);
      }
    });

    // Inicializar el carrito
    (async () => {
      try {
        // Cargar el m√≥dulo del carrito
        const { initCartEventListeners } = await import('../scripts/cart');
        if (typeof initCartEventListeners === 'function') {
          console.log('Inicializando carrito desde el header...');
          initCartEventListeners();
        } else {
          console.warn('La funci√≥n initCartEventListeners no est√° disponible');
        }
      } catch (error) {
        console.error('Error al cargar el carrito:', error);
      }
    })();
  });
</script>

<header class="header">
  <div class="contenedor header__contenedor">
    <!-- Logo -->
    <a href="/" class="header__logo" aria-label="Hilo M√°gico - Inicio">
      <img src="/img/hilo-magico-header.png" alt="Hilo M√°gico" width="200" height="100" />
    </a>
    
    <!-- Bot√≥n de men√∫ m√≥vil -->
    <button 
      class="header__menu-btn" 
      id="menu-btn"
      aria-label="Men√∫ principal"
      aria-expanded="false"
      aria-controls="menu-principal"
    >
      <span class="header__menu-icon"></span>
      <span class="sr-only">Men√∫</span>
    </button>
    
    <!-- Navegaci√≥n principal -->
    <nav 
      class="header__nav" 
      id="menu-principal" 
      aria-label="Navegaci√≥n principal"
    >
      <ul class="header__menu">
        {enlaces.map((enlace) => (
          <li class="header__menu-item">
            <a 
              href={enlace.url} 
              class="header__enlace"
            >
              {enlace.texto}
            </a>
          </li>
        ))}
        
        {esAdmin && (
          <li class="header__menu-item header__menu-item--admin">
            <button 
              class="header__enlace header__enlace--admin"
              aria-expanded="false"
              aria-controls="admin-submenu"
            >
              Administraci√≥n
            </button>
            <ul class="header__submenu" id="admin-submenu">
              {adminEnlaces.map((enlace) => (
                <li class="header__submenu-item">
                  <a href={enlace.url} class="header__submenu-link">
                    <i class="fas fa-cog mr-2" aria-hidden="true"></i>
                    {enlace.texto}
                  </a>
                </li>
              ))}
            </ul>
          </li>
        )}
      </ul>
    </nav>

    <!-- Botones de la derecha (carrito y perfil) -->
    <div class="header__acciones">
      <!-- Bot√≥n del carrito -->
      <button 
        class="header__carrito-btn" 
        id="carrito-btn"
        aria-label="Carrito de compras"
        aria-expanded="false"
        aria-controls="carrito"
      >
        <i class="fas fa-shopping-cart" aria-hidden="true"></i>
        <span class="header__carrito-contador" id="contador-carrito">0</span>
        <span class="sr-only">Ver carrito</span>
      </button>
      
      {autenticado ? (
        <!-- Usuario autenticado -->
        <div class="header__user">
          <div class="header__user-dropdown">
            <button 
              class="header__user-btn"
              onclick="this.nextElementSibling?.classList.toggle('header__user-menu--visible'); this.setAttribute('aria-expanded', this.nextElementSibling?.classList.contains('header__user-menu--visible'))"
              aria-expanded="false"
              aria-controls="user-menu"
            >
              <i class="fas fa-user" aria-hidden="true"></i>
              <span class="header__user-name">{getNombreCompleto(usuario)}</span>
              <i class="fas fa-chevron-down header__user-arrow"></i>
            </button>
            
            <div class="header__user-menu" id="user-menu">
              <div class="header__user-info">
                <p class="header__user-name">{getNombreCompleto(usuario)}</p>
                <p class="header__user-email">{usuario?.email || ''}</p>
              </div>
              
              <nav class="header__user-nav">
                <a href="/profile" class="header__user-link">
                  <i class="fas fa-user" aria-hidden="true"></i>
                  Mi perfil
                </a>
                <a href="/orders" class="header__user-link">
                  <i class="fas fa-box" aria-hidden="true"></i>
                  Mis pedidos
                </a>
                <a href="/settings" class="header__user-link">
                  <i class="fas fa-cog" aria-hidden="true"></i>
                  Configuraci√≥n
                </a>
                {esAdmin && (
                  <a href="/admin" class="header__user-link">
                    <i class="fas fa-shield-alt" aria-hidden="true"></i>
                    Administraci√≥n
                  </a>
                )}
                <button 
                  class="header__user-link header__user-link--logout"
                  onclick="(async () => {
                    try {
                      const response = await fetch('/api/auth/logout', { method: 'POST' });
                      if (response.ok) {
                        localStorage.removeItem('user');
                        localStorage.removeItem('access_token');
                        window.location.href = '/';
                      }
                    } catch (error) {
                      console.error('Error al cerrar sesi√≥n:', error);
                    }
                  })()"
                >
                  <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                  Cerrar sesi√≥n
                </button>
              </nav>
            </div>
          </div>
        </div>
      ) : (
        <!-- Usuario no autenticado -->
        <div class="header__auth">
          <a href="/auth/register" class="header__auth-link">Registrarse</a>
          <a href="/auth/login" class="header__auth-link header__auth-link--login">Iniciar sesi√≥n</a>
        </div>
      )}
    </div>
    
    <!-- Overlay para men√∫ m√≥vil -->
    <div 
      class="header__overlay" 
      id="menu-overlay" 
      role="presentation"
      tabindex="-1"
      aria-hidden="true"
    ></div>
  </div>
</header>
