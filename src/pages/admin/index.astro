---
// src/pages/admin/index.astro
import type { Order, Product } from '@/types/admin';
import AdminLayout from '../../layouts/admin/AdminLayout.astro';
import { getCurrentUser } from '../../utils/auth';

// Configuración de la página
const pageTitle = 'Dashboard';
const pageDescription = 'Vista general del panel de administración';

// Obtener información del usuario actual
const currentUser = getCurrentUser();

// Si no hay usuario, redirigir al login
if (!currentUser) {
  return Astro.redirect('/auth/login');
}

// Si no es admin, redirigir al inicio
if (currentUser.role !== 'admin') {
  return Astro.redirect('/');
}

// Datos de ejemplo para el dashboard
const stats = [
  { 
    name: 'Ventas Totales', 
    value: '$12,450',
    change: '+5.2%',
    changeType: 'increase'
  },
  { 
    name: 'Pedidos Pendientes', 
    value: '45',
    change: '+3',
    changeType: 'increase'
  },
  { 
    name: 'Stock Bajo', 
    value: '12',
    change: '-2',
    changeType: 'decrease'
  },
  { 
    name: 'Clientes Nuevos', 
    value: '28',
    change: '+8',
    changeType: 'increase'
  }
];

const recentOrders = [
  {
    id: 1,
    customer: 'Juan Pérez',
    total: '$250.00',
    status: 'pending',
    date: '2025-06-27'
  },
  {
    id: 2,
    customer: 'María García',
    total: '$120.00',
    status: 'completed',
    date: '2025-06-26'
  },
  {
    id: 3,
    customer: 'Carlos López',
    total: '$180.00',
    status: 'processing',
    date: '2025-06-25'
  }
];

const topProducts = [
    changeType: 'increase',
    icon: 'fas fa-shopping-cart',
    color: 'bg-blue-100 text-blue-600'
  },
  { 
    name: 'Pedidos', 
    value: '1,234', 
    change: '+5%', 
    changeType: 'increase',
    icon: 'fas fa-box',
    color: 'bg-green-100 text-green-600'
  },
  { 
    name: 'Clientes', 
    value: '845', 
    change: '+8%', 
    changeType: 'increase',
    icon: 'fas fa-users',
    color: 'bg-purple-100 text-purple-600'
  },
  { 
    name: 'Tasa de Conversión', 
    value: '3.2%', 
    change: '-0.5%', 
    changeType: 'decrease',
    icon: 'fas fa-chart-line',
    color: 'bg-yellow-100 text-yellow-600'
  }
];

const recentOrders: Order[] = [
  { id: '#ORD-001', customer: 'María Gómez', date: '15 Jun 2023', amount: '$120.00', status: 'Completado', statusColor: 'bg-green-100 text-green-800' },
  { id: '#ORD-002', customer: 'Carlos López', date: '14 Jun 2023', amount: '$85.50', status: 'En Proceso', statusColor: 'bg-blue-100 text-blue-800' },
  { id: '#ORD-003', customer: 'Ana Martínez', date: '14 Jun 2023', amount: '$210.75', status: 'Enviado', statusColor: 'bg-yellow-100 text-yellow-800' },
  { id: '#ORD-004', customer: 'Juan Pérez', date: '13 Jun 2023', amount: '$65.99', status: 'Pendiente', statusColor: 'bg-gray-100 text-gray-800' },
  { id: '#ORD-005', customer: 'Laura Sánchez', date: '12 Jun 2023', amount: '$175.25', status: 'Completado', statusColor: 'bg-green-100 text-green-800' }
];

const topProducts: Product[] = [
  { name: 'Vestido Floral', category: 'Ropa', sales: 142, stock: 50, status: 'Disponible', revenue: '$2,840.00', image: '/images/products/dress-1.jpg' },
  { name: 'Blusa de Encaje', category: 'Ropa', sales: 98, stock: 30, status: 'Bajo Stock', revenue: '$1,764.00', image: '/images/products/blouse-1.jpg' },
  { name: 'Falda Plisada', category: 'Ropa', sales: 75, stock: 20, status: 'Bajo Stock', revenue: '$1,350.00', image: '/images/products/skirt-1.jpg' },
  { name: 'Conjunto Deportivo', category: 'Ropa', sales: 63, stock: 40, status: 'Disponible', revenue: '$1,197.00', image: '/images/products/activewear-1.jpg' },
  { name: 'Abrigo Largo', category: 'Ropa', sales: 51, stock: 10, status: 'Bajo Stock', revenue: '$1,275.00', image: '/images/products/coat-1.jpg' }
];
---

<AdminLayout title={pageTitle} description={pageDescription} currentPage="dashboard">
  <div class="space-y-6">
    <!-- Encabezado -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Hola, {currentUser?.first_name || 'Administrador'}</h1>
        <p class="text-gray-600">Bienvenido al panel de control. Aquí tienes un resumen de tu tienda.</p>
      </div>
      <div class="flex flex-wrap gap-3">
        <a href="/admin/orders/new" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          <i class="fas fa-plus mr-2"></i> Nuevo Pedido
        </a>
        <a href="/admin/products/new" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          <i class="fas fa-plus mr-2"></i> Nuevo Producto
        </a>
      </div>
    </div>
    
    <!-- Tarjetas de estadísticas -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      {stats.map((stat) => (
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-500">{stat.name}</p>
              <p class="mt-1 text-2xl font-semibold text-gray-900">{stat.value}</p>
            </div>
            <div class={`p-3 rounded-full ${stat.color} bg-opacity-20`}>
              <i class={`${stat.icon} text-lg`}></i>
            </div>
          </div>
          <div class="mt-4">
            <div class={`inline-flex items-center text-sm font-medium ${stat.changeType === 'increase' ? 'text-green-600' : 'text-red-600'}`}>
              {stat.changeType === 'increase' ? (
                <i class="fas fa-arrow-up mr-1"></i>
              ) : (
                <i class="fas fa-arrow-down mr-1"></i>
              )}
              {stat.change}
            </div>
            <span class="text-sm text-gray-500 ml-2">vs mes anterior</span>
          </div>
        </div>
      ))}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Gráfico de ventas -->
      <div class="lg:col-span-2 bg-white rounded-lg shadow p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
          <h2 class="text-lg font-semibold text-gray-900">Resumen de ventas</h2>
          <div class="mt-3 sm:mt-0">
            <select class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
              <option>Últimos 7 días</option>
              <option>Últimos 30 días</option>
              <option>Últimos 90 días</option>
              <option>Último año</option>
            </select>
          </div>
        </div>
        <div class="h-80 bg-gray-50 rounded-lg flex items-center justify-center">
          <div class="text-center p-6">
            <i class="fas fa-chart-line text-4xl text-gray-300 mb-2"></i>
            <p class="text-gray-500">Gráfico de ventas</p>
            <p class="text-sm text-gray-400 mt-1">Se mostrará el gráfico de ventas aquí</p>
          </div>
        </div>
      </div>

      <!-- Productos más vendidos -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Productos más vendidos</h2>
        </div>
        <div class="divide-y divide-gray-200">
          {topProducts.map((product, index) => (
            <a href={`/admin/products/${product.name.toLowerCase().replace(/\s+/g, '-')}`} class="block hover:bg-gray-50 transition-colors">
              <div class="px-6 py-4">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-12 w-12 bg-gray-200 rounded-lg overflow-hidden">
                    {product.image ? (
                      <img src={product.image} alt={product.name} class="h-full w-full object-cover" />
                    ) : (
                      <div class="h-full w-full flex items-center justify-center bg-gray-100 text-gray-400">
                        <i class="fas fa-box text-xl"></i>
                      </div>
                    )}
                  </div>
                  <div class="ml-4 flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">{product.name}</p>
                    <div class="flex items-center mt-1">
                      <span class="text-xs text-gray-500">{product.sales} ventas</span>
                      <span class="mx-2 text-gray-300">•</span>
                      <span class="text-xs font-medium text-gray-900">{product.revenue}</span>
                    </div>
                  </div>
                  <div class="ml-4">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      <i class="fas fa-arrow-up mr-1 text-xs"></i> 12.5%
                    </span>
                  </div>
                </div>
              </div>
            </a>
          ))}
        </div>
        <div class="bg-gray-50 px-6 py-3 text-right">
      </div>
    </div>

    <div class="dashboard-content">
      <div class="card">
        <div class="card-header">
          <h2>Últimos Pedidos</h2>
        </div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th>ID Pedido</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {recentOrders.map((order) => (
                <tr>
                  <td>{order.id}</td>
                  <td>{order.customer}</td>
                  <td>{order.date}</td>
                  <td>{order.amount}</td>
                  <td>
                    <span class="badge" style={order.statusColor}>
                      {order.status}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Productos Populares</h2>
        </div>
        <div class="card-body">
          <table class="table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Categoría</th>
                <th>Ventas</th>
                <th>Stock</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {topProducts.map((product) => (
                <tr>
                  <td>{product.name}</td>
                  <td>{product.category}</td>
                  <td>{product.sales}</td>
                  <td>{product.stock}</td>
                  <td>
                    <span class="badge badge-{product.status === 'Bajo Stock' ? 'warning' : 'success'}">
                      {product.status}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>
