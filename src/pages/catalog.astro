---
// src/pages/catalog.astro
import BaseLayout from '../layouts/BaseLayout.astro';
import CatalogFilters from '../components/catalog/CatalogFilters.astro';
import StoresList from '../components/catalog/StoresList.astro';
import { groupProductsByStore } from '../utils/filters';
import { productos, tiendas } from '../data/productos';

// Obtener categorías de la URL
const url = new URL(Astro.request.url);
const categoriasSeleccionadas = url.searchParams.get('categorias')?.split(',').filter(Boolean) || [];

// Filtrar tiendas por categorías seleccionadas
const tiendasFiltradas = categoriasSeleccionadas.length > 0
  ? tiendas.filter(tienda => 
      tienda.categorias.some(cat => categoriasSeleccionadas.includes(cat))
    )
  : tiendas;

// Agrupar productos por tienda
const tiendasConProductos = groupProductsByStore(tiendasFiltradas, productos);

// Verificar si hay productos en cada tienda
const tiendasVisibles = tiendasConProductos.filter(tienda => tienda.productos.length > 0);

// Obtener todas las categorías únicas para los filtros
const categoriasUnicas = Array.from(
  new Set(tiendas.flatMap(tienda => tienda.categorias))
).sort();
---

<BaseLayout title="Catálogo | Hilo Mágico" description="Explora nuestra colección de productos únicos y personalizados">
  <main class="catalog-page">
    <div class="container">
      <h1 class="page-title">Catálogo de Productos</h1>
      
      <div class="catalog-layout">
        <!-- Componente de Filtros -->
        <CatalogFilters 
          categorias={categoriasUnicas} 
          initialCategorias={categoriasSeleccionadas} 
          onCategoriaChange={(nuevasCategorias: string[]) => {
            const params = new URLSearchParams();
            if (nuevasCategorias.length > 0) {
              params.set('categorias', nuevasCategorias.join(','));
            }
            window.location.href = `${Astro.url.pathname}?${params.toString()}`;
          }}
        />
        
        <!-- Componente de Lista de Tiendas -->
        <StoresList 
          tiendas={tiendasVisibles}
        />
      </div>
    </div>
  </main>
  
  <script>
    // Scripts específicos del catálogo
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Catálogo cargado');
      // Aquí puedes agregar cualquier inicialización específica del catálogo
    });
  </script>
</BaseLayout>
