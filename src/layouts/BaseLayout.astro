---
// src/layouts/BaseLayout.astro

// Tipos de TypeScript
interface Props {
  title?: string;
  description?: string;
  image?: string;
  canonical?: string;
  noindex?: boolean;
  structuredData?: any;
}

// Configuración del sitio
const SITE_URL = 'https://hilo-magico.com';
const SITE_NAME = 'Hilo Mágico';
const TWITTER_HANDLE = '@hilo_magico_scz';
const DEFAULT_DESCRIPTION = 'Prendas personalizadas y servicios de costura a medida con los mejores materiales y diseños únicos.';
const DEFAULT_IMAGE = SITE_URL + '/img/og-image.jpg';

// Valores predeterminados para los props
const { 
  title: pageTitle = SITE_NAME, 
  description = DEFAULT_DESCRIPTION,
  image = DEFAULT_IMAGE,
  canonical = '',
  noindex = false,
  structuredData = null
} = Astro.props;

// Construir URLs
const fullTitle = pageTitle === SITE_NAME ? SITE_NAME : `${pageTitle} | ${SITE_NAME}`;
const pageUrl = new URL(Astro.url.pathname, SITE_URL).href;
const canonicalUrl = canonical || pageUrl;
const fullImageUrl = image.startsWith('http') ? image : new URL(image, SITE_URL).href;

// Configuración de Open Graph
const ogType = Astro.url.pathname === '/' ? 'website' : 'article';

// Importamos los componentes
import Header from '../components/ui/Header';
import Footer from '../components/Footer.astro';
import ChatBubble from '../components/ChatBubble.astro';

// Importamos los estilos globales
import '../styles/main.scss';

// Generar datos estructurados por defecto si no se proporcionan
const defaultStructuredData = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": SITE_NAME,
  "url": SITE_URL,
  "potentialAction": {
    "@type": "SearchAction",
    "target": `${SITE_URL}/buscar?q={search_term_string}`,
    "query-input": "required name=search_term_string"
  }
};

const pageStructuredData = structuredData || defaultStructuredData;
---

<!DOCTYPE html>
<html lang="es" class="no-js" itemscope itemtype="https://schema.org/WebPage">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="description" content={description} />
    
    <!-- Título de la página -->
    <title>{fullTitle}</title>
    <meta name="description" content={description} />
    
    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={fullImageUrl} />
    <meta property="og:site_name" content={SITE_NAME} />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content={TWITTER_HANDLE} />
    <meta name="twitter:creator" content={TWITTER_HANDLE} />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={fullImageUrl} />
    
    <!-- No indexar si es necesario -->
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    
    <!-- Preconexiones -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Preload de fuentes críticas -->
    <link rel="preload" href="/fonts/your-font.woff2" as="font" type="font/woff2" crossorigin />
    
    <!-- Datos estructurados -->
    <script type="application/ld+json">
      {JSON.stringify(pageStructuredData, null, 2)}
    </script>
    
    <!-- Preconexión con recursos externos -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous" />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    
    <!-- Precargar recursos críticos -->
    <link rel="preload" href="/fonts/your-font.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
    <link rel="preload" href="/styles/main.scss" as="style" />
    
    <!-- Favicon y Web App Manifest -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Metaetiquetas para SEO -->
    <meta name="robots" content={noindex ? 'noindex, nofollow' : 'index, follow'} />
    <meta name="theme-color" content="#3e195f" />
    <meta name="author" content="Hilo Mágico" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:site_name" content={SITE_NAME} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={new URL(image, SITE_URL).href} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content="es_ES" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@hilo_magico" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(image, SITE_URL).href} />
    
    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />
    
    <!-- Estilos -->
    <link rel="stylesheet" href="../styles/main.scss" />
    
    <!-- Carga no bloqueante de fuentes -->
    <link 
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Quicksand:wght@300;400;500;600;700&display=swap" 
      rel="stylesheet" 
      media="print" 
      onload="this.media='all'"
    />
    
    <!-- Carga no bloqueante de Font Awesome -->
    <link 
      rel="stylesheet" 
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
      media="print" 
      onload="this.media='all'"
    />
    
    <!-- Scripts del lado del cliente con carga diferida -->
    <script>
      // Definir tipos para Web Vitals
      interface WebVitalsGlobal {
        getCLS: (onReport: (metric: any) => void) => void;
        getFID: (onReport: (metric: any) => void) => void;
        getLCP: (onReport: (metric: any) => void) => void;
      }

      // Extender la interfaz Window
      declare global {
        interface Window {
          webVitals?: WebVitalsGlobal;
        }
      }

      // Detectar si JavaScript está habilitado
      document.documentElement.classList.remove('no-js');
      document.documentElement.classList.add('js');
      
      // Cargar scripts críticos de forma asíncrona
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('ServiceWorker registrado con éxito: ', registration.scope);
            })
            .catch(error => {
              console.log('Error al registrar el ServiceWorker: ', error);
            });
        });
      }
      
      // Web Vitals (solo en producción)
      if (window.location.hostname !== 'localhost') {
        const reportWebVitals = (metric: { delta: number }) => {
          if (metric.delta < 1500) {
            console.log(metric);
            // Aquí podrías enviar las métricas a tu servicio de análisis
          }
        };

        if (typeof window !== 'undefined' && window.webVitals) {
          window.webVitals.getCLS(reportWebVitals);
          window.webVitals.getFID(reportWebVitals);
          window.webVitals.getLCP(reportWebVitals);
        }
      }
    </script>
    
    <!-- Schema.org markup para Google -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "LocalBusiness",
      "name": "Hilo Mágico",
      "image": "https://hilo-magico.com/img/og-image.jpg",
      "description": "Prendas personalizadas y servicios de costura a medida con los mejores materiales y diseños únicos.",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Ciudad",
        "addressRegion": "Región",
        "postalCode": "Código Postal",
        "streetAddress": "Dirección"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": "40.7128",
        "longitude": "-74.0060"
      },
      "url": "https://hilo-magico.com",
      "telephone": "+1234567890",
      "openingHoursSpecification": [
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
          "opens": "09:00",
          "closes": "18:00"
        },
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": "Saturday",
          "opens": "10:00",
          "closes": "14:00"
        }
      ],
      "priceRange": "$$",
      "sameAs": [
        "https://www.facebook.com/hilomagico",
        "https://www.instagram.com/hilomagico",
        "https://pinterest.com/hilomagico"
      ]
    }
    </script>
  </head>
  
  <body aria-busy="false">
    <!-- Skip link para accesibilidad -->
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    
    <!-- Indicador de carga (deshabilitado hasta integración con backend)
    <div class="page-loader" aria-hidden="true" style="display: none;">
      <div class="loader"></div>
    </div>
    -->
    
    <!-- Header como componente React con hidratación en el cliente -->
    <Header client:load />
    
    <!-- Contenido principal -->
    <main id="main-content" role="main" tabindex="-1">
      <slot />
    </main>
    
    <!-- Footer -->
    <Footer />
    
    <!-- Chat flotante -->
    <ChatBubble />
    
    <!-- Scripts -->
    <script src="/js/main.js" type="module"></script>
    
    <!-- Registrar Service Worker -->
    <script src="/js/register-sw.js" type="module"></script>
    
    <!-- Preload de recursos críticos -->
    <link rel="preload" href="/styles/main.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="/styles/main.css"></noscript>
    
    <!-- Scripts al final del body para mejor rendimiento -->
    <script>
      // Cargar scripts no críticos de forma diferida
      function loadScript(src: string, callback?: () => void) {
        const script = document.createElement('script');
        script.src = src;
        script.defer = true;
        if (callback) script.onload = callback;
        document.body.appendChild(script);
      }
      
      // Cargar scripts no críticos
      window.addEventListener('load', () => {
        // Ejemplo: loadScript('/js/non-critical.js');
      });
    </script>
    
    <!-- Carga de Web Vitals solo en producción -->
    {import.meta.env.PROD && (
      <script src="https://unpkg.com/web-vitals@2.1.4/dist/web-vitals.attribution.iife.js" defer></script>
    )}
  </body>
</html>
